<div class="feed">
  <div class="post-card" *ngFor="let post of allPosts" [id]="post.id" #postElement>

    <div class="post-header" (click)="GoToUser()">
      <a (click)="GoToUser(post.user!.userId)" class="user-link">
        <img class="profile-pic" [src]="post.user!.profilePicUrl" alt="Profile picture">
        <span class="username">{{ post.user?.firstName }} {{ post.user?.lastName }}</span>
      </a>
    </div>

    <div class="post-media" *ngFor="let media of post.mediaFiles">
      <ng-container [ngSwitch]="media.mediaType">
        <img *ngSwitchCase="'image'" [src]="media.url" alt="Image from the post" class="post-image" />
        <video
          *ngSwitchCase="'video'"
          [src]="media.url"
          muted
          loop
          playsinline
          controls
          (mouseenter)="playVideo($event)"
          (mouseleave)="pauseVideo($event)"
          class="post-video">
        </video>
        <p *ngSwitchDefault class="unsupported-media">Unsupported media type</p>
      </ng-container>
    </div>

    <div class="post-actions">
      <div class="action-button">
        <lucide-icon
          name="heart"
          class="heart-icon"
          [ngClass]="{ 'liked': isPostLiked(post), 'not-liked': !isPostLiked(post) }"
          (click)="toggleLike(post.id!, user.userId!)">
        </lucide-icon>
        <span class="like-count">{{ post.likes?.length || 0 }}</span>
      </div>

      <div class="action-button" (click)="toggleCommentBox(post.id)">
        <lucide-icon name="MessageCircle"></lucide-icon>
      </div>

      <div class="action-button" (click)="toggleSavePost(post.id)">
        <lucide-icon
          name="bookmark"
          [ngClass]="{ 'saved': isPostSaved(post), 'not-saved': !isPostSaved(post) }">
        </lucide-icon>
      </div>

      <div class="action-button" (click)="sharePost(post.id)">
        <lucide-icon name="send"></lucide-icon>
      </div>
    </div>

     <div class="post-description">
        <div class="description-header">
          <strong>{{ post.user?.firstName }} {{ post.user?.lastName }}</strong>
          <button 
            class="ai-sparkle-btn" 
            (click)="summarize(post.id, post.content)"
            [disabled]="loadingSummaries[post.id]"
            [class.loading]="loadingSummaries[post.id]">
              <span class="ai-icon">✨</span>
              <span class="sum">AI Summary</span>
          </button>
        </div>
        <span
          [ngClass]="{collapsed: !expandedPostIds.includes(post.id),
            expanded: expandedPostIds.includes(post.id)}"
          (click)="toggleReadMore(post.id)">
          {{ post.content }}
        </span>
        
        <div class="ai-summary-popup" *ngIf="hasSummary(post.id)">
            <button class="close-btn" (click)="closeSummary(post.id)">×</button>
          <div class="summary-content">
            {{ getSummary(post.id) }}
          </div>
        </div>
      </div>

    <div class="view-comments">
      <button class="view-comments-button" (click)="toggleCommentsList(post.id)">
        <ng-container *ngIf="post.comments?.length > 0; else noComments">
          Show all {{ post.comments.length }} comments
        </ng-container>
        <ng-template #noComments>No comments yet</ng-template>
      </button>
    </div>

    <div class="comments-list" *ngIf="commentsListPostId === post.id && post.comments?.length">
      <div class="comment-line" *ngFor="let c of getVisibleComments(post)">
        <strong>{{ c.userName }}</strong> {{ c.content }}
      </div>
      <button *ngIf="shouldShowReadMore(post)" class="read-more-btn" (click)="toggleReadMore(post.id)">
        {{ expandedPostIds.includes(post.id) ? 'Show less' : 'Read more' }}
      </button>
    </div>

    <div *ngIf="showMessage"
         [ngClass]="{'success': isSuccess, 'error': !isSuccess}"
         class="floating-message">
      {{ messageText }}
    </div>

    <div class="add-comment" *ngIf="commentBoxPostId === post.id" style="display: flex; align-items: center; gap: 0.5rem;">
      <div class="emoji-button-wrapper" style="position: relative;">
        <button class="icon-btn" (click)="toggleEmojiPicker()" aria-label="emoji">
          <lucide-icon name="smile"></lucide-icon>
        </button>
        <div *ngIf="showEmojiPicker" class="emoji-picker-popover" #emojiPickerRef>
          <emoji-mart (emojiSelect)="addEmoji($event)" [style]="{ width: '300px', height: '350px' }"
          [showPreview]="false"></emoji-mart>
        </div>
      </div>
      <input
        type="text"
        placeholder="Add a comment..."
        [(ngModel)]="newCommentContent"
        #messageInputRef
        (keydown.enter)="sendComment(post.id); $event.preventDefault()"
        style="flex: 1;"/>
      <button aria-label="Send a comment" (click)="sendComment(post.id)">
        <lucide-icon name="send"></lucide-icon>
      </button>
    </div>

  </div>
</div>
