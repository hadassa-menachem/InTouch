<div class="create-story-container">
  <form [formGroup]="createStoryForm" (ngSubmit)="onSubmit()">
    
    <div class="story-preview-box">
      <div class="story-preview" [class.has-media]="imagePreviewUrl">
        
        <button 
          *ngIf="imagePreviewUrl" 
          type="button" 
          class="remove-media-btn"
          (click)="removeMedia()">
          <lucide-icon name="X" [size]="20"></lucide-icon>
        </button>

        <div class="upload-overlay-corner" *ngIf="!imagePreviewUrl">
          <input 
            type="file" 
            id="fileInput"
            (change)="onFileSelected($event)" 
            accept="image/*,video/*"
            style="display: none"/>
          <label for="fileInput" class="upload-btn-corner">
            <lucide-icon name="Plus" [size]="32"></lucide-icon>
          </label>
        </div>

        <ng-container *ngIf="imagePreviewUrl">
          <img
            *ngIf="createStoryForm.value.mediaType === 'image'"
            [src]="imagePreviewUrl"
            class="preview-image"/>

          <video
            *ngIf="createStoryForm.value.mediaType === 'video'"
            [src]="imagePreviewUrl"
            class="preview-video"
            autoplay
            muted
            loop>
          </video>
        </ng-container>

        <div class="no-media-message" *ngIf="!imagePreviewUrl">
          <lucide-icon name="image" [size]="64"></lucide-icon>
          <p>Upload photo or video</p>
        </div>

        <div
          *ngIf="createStoryForm.value.customText"
          class="draggable-text"
          cdkDrag
          cdkDragBoundary=".story-preview"
          [cdkDragFreeDragPosition]="dragPosition"
          [style.color]="createStoryForm.value.textColor"
          [style.font-size.px]="textSize"
          (cdkDragEnded)="onDragEnded($event)">
          {{ createStoryForm.value.customText }}
        </div>

        <div class="icons-toolbar">
          <button 
            type="button" 
            class="icon-btn" 
            [class.active]="showTextInput"
            (click)="toggleTextInput()">
            <lucide-icon name="type"></lucide-icon>
            <span>Text</span>
          </button>
          
          <button 
            type="button" 
            class="icon-btn"
            [class.active]="showColorPicker"
            (click)="toggleColorPicker()">
            <lucide-icon name="palette"></lucide-icon>
            <span>Color</span>
          </button>
          
          <button 
            type="button" 
            class="icon-btn"
            [class.active]="showSettings"
            (click)="toggleSettings()">
            <lucide-icon name="Clock"></lucide-icon>
            <span>Time</span>
          </button>
          
          <button type="submit" class="icon-btn" [disabled]="!imagePreviewUrl">
            <lucide-icon name="send"></lucide-icon>
            <span>Publish</span>
          </button>
        </div>
        
        <div class="popup-box text-popup" *ngIf="showTextInput">
          <div class="text-with-emoji-inline">
            <input
              formControlName="customText"
              #messageInputRef
              type="text"
              placeholder="Type text..." />
            <button 
              type="button" 
              class="emoji-btn-inline"
              #emojiButtonRef
              [class.active]="showEmojiPicker"
              (click)="toggleEmojiPicker($event)">
              <lucide-icon name="smile" [size]="18"></lucide-icon>
            </button>
          </div>
          
          <div class="emoji-dropdown" *ngIf="showEmojiPicker" #emojiPickerRef>
            <emoji-mart 
              (emojiSelect)="addEmoji($event)"
              [style]="{ width: '100%', maxWidth: '320px' }"
              [showPreview]="false">
            </emoji-mart>
          </div>
                      
          <div class="setting-item">
            <label>Text Size: {{textSize}}px</label>
            <input
              type="range"
              min="12"
              max="60"
              [(ngModel)]="textSize"
              [ngModelOptions]="{ standalone: true }"/>
          </div>
        </div>

        <div class="popup-box color-popup" *ngIf="showColorPicker">
          <div class="color-row">
            <button 
              type="button" 
              *ngFor="let color of colorOptions" 
              class="color-dot"
              [style.background]="color"
              [class.selected]="createStoryForm.value.textColor === color"
              (click)="selectColor(color)">
            </button>
          </div>
          <input type="color" formControlName="textColor" class="color-input-custom"/>
        </div>

        <div class="popup-box settings-popup" *ngIf="showSettings">
          <div class="settings-row">
            <div class="setting-item">
              <label>Duration (hours)</label>
              <input
                type="number"
                formControlName="durationHours"
                min="1"
                max="24"
                placeholder="24"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div 
      *ngIf="showMessage" 
      [ngClass]="{ 'success': isSuccess, 'error': !isSuccess }" 
      class="floating-message">
      {{ messageText }}
    </div>
  </form>
</div>